---
output: html_document
---

```{css, echo=FALSE}
/* this chunk of code centers all of the headings */
h1, h2, h3, h4, h5 {
  text-align: center;
}
```

<br>

```{r pressure, echo=FALSE, fig.align="center", out.width = '150%'}
knitr::include_graphics("query-catcher-header.png")
```

<br>

```{r, include=FALSE, warning=FALSE, message=FALSE}
rm(list = ls())

library("tidyverse")
library("lubridate")
library("plotly")
library("DT")
library("scales")

query_subgraph = function(api_or_query_key, endpoint, graphql_query){
  
  library("ghql")
  library("jsonlite")
  
  graphql_conn <- ghql::GraphqlClient$new(
    url = endpoint, 
    headers = list(Authorization = paste0("Bearer ", api_or_query_key)))
  
  qry <- Query$new()
  qry$query('query_table', graphql_query)
  query_table <- graphql_conn$exec(qry$queries$query_table)
  query_table <- jsonlite::fromJSON(query_table)
  query_table <- query_table$data
  query_table
}

unix_today = as.numeric(as.POSIXct(today(), format="%Y-%m-%d"))
date_30d_before = (as.Date(today(), format="%d/%m/%Y") - 30)
unix_30d_before = as.numeric(as.POSIXct(date_30d_before, format="%Y-%m-%d"))

my_query_key = "0d6e70a116072e66eb0ef8de2fe3cef1"
qos_oracle = "https://api.thegraph.com/subgraphs/name/juanmardefago/gateway-qos-oracle"
top_indexers_query = str_c('{
  indexers(
    first: 50
    orderBy: id
    orderDirection: asc
    where: {indexerDailyDataPoints_: {query_count_gt: "100"}}
  ) {
    id
    indexerDailyDataPoints(
      orderBy: query_count
      orderDirection: desc
      where: {dayStart_gt: "1706227200"}
    ) {
      subgraph_deployment_ipfs_hash
      query_count
      total_query_fees
      avg_query_fee
      dataPoints(orderDirection: desc, where: {dayStart_gt: "1706227200"}) {
        avg_indexer_latency_ms
        avg_indexer_blocks_behind
        subgraphDeployment {
          id
          queryDailyDataPoints(orderDirection: desc, where: {dayStart_gt: "1706227200"}) {
            query_count
            max_gateway_latency_ms
            max_query_fee
          }
        }
      }
    }
  }
}')

qos_indexer_data = query_subgraph(my_query_key, qos_oracle, top_indexers_query)
qos_indexer_data = qos_indexer_data$indexers

qos_indexer_data
```

```{r}
something = unnest_longer(qos_indexer_data,
              indexerDailyDataPoints,
              indices_include = FALSE) %>% 
  unnest(indexerDailyDataPoints) %>% 
  mutate(query_count = as.numeric(query_count)) %>% 
  rename(wallet_address = id) %>% 
  group_by(wallet_address) %>% 
  summarise(query_count = sum(query_count)) %>% 
  arrange(-query_count)
```


```{r, fig.height=6.5, fig.width=9.5, fig.align="center", echo=FALSE, warning=FALSE, message=FALSE}



indexers_plot = monthly_totals %>% 
  slice_max(query_count, n = 50) %>% 
  mutate(wallet_address = str_c(substr(wallet_address, 1, 4),"-",str_sub(wallet_address,-4,-1)),
         wallet_address = if_else(
           wallet_address %in% c("0x92-6c1e", "0x84-9948"), "ðŸ§  Braindexer", wallet_address),
         braindexer = if_else(wallet_address == "ðŸ§  Braindexer", "Braindexer", "Other"),
         wallet_address = fct_reorder(wallet_address, -query_count)) %>% 
  ggplot(aes(x=wallet_address, y=query_count, color=braindexer)) + 
  geom_segment(aes(x=wallet_address, xend=wallet_address, y=0, yend=query_count)) +
  geom_point(size=2, alpha=1, stroke=1) +
  theme_minimal() +
  theme(panel.background = element_rect(
        fill = "white", colour = "white", size = 0.5, linetype = "solid"),
        plot.title = element_text(size=14, face="bold", hjust=0.5),
        axis.title.x = element_blank(),
        axis.title.y = element_text(size=6, family = "Arial", colour="#000000"),
        axis.text.x = element_text(size=4, angle = 45, vjust = 0.5, hjust=1),
        axis.text.y = element_text(size=6, family = "Arial", colour="#000000"),
        legend.position = "none") +
   labs(title="Queries Served by Indexers (Past 30D)", 
        y = "Queries Served by Indexer (Past 30D)") +
   scale_color_manual(values=c("#E9A1C9", "#00CED4")) +
   scale_y_continuous(labels = comma)
ggplotly(indexers_plot) 
```

```{r, echo=FALSE}
datatable(monthly_totals %>% 
            mutate(query_count = format(query_count, nsmall=0, big.mark=","),
                   wallet_address = if_else(
                     wallet_address == "0x920fdeb00ee04dd72f62d8a8f80f13c82ef76c1e",
                     "ðŸ§  Braindexer Arbitrum Indexer (0x920-76c1e)", wallet_address)) %>% 
            arrange(desc(query_count)), 
          caption = "Top Indexers Serving Queries over Past 30 Days", 
          rownames = FALSE,  options = list(pageLength = 25))
```







