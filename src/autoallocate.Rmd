---
output: html_document
---

```{css, echo=FALSE}
/* this chunk of code centers all of the headings */
h1, h2 {
  text-align: center;
}
```

<br>

```{r pressure, echo=FALSE, fig.align="center", out.width = '150%'}
knitr::include_graphics("query-catcher-header.png")
```

<br>

```{r setup, include=FALSE, warning=FALSE, message=FALSE}
rm(list = ls())
options(scipen = 999)

wallet_to_analyze = "0x920fdeb00ee04dd72f62d8a8f80f13c82ef76c1e"

library("tidyverse")
library("janitor")
library("lubridate")
library("DT")
library("onchainR")
library("here")
source(here("src", "helpers", "notion.R")) #library("notionR")
source("~/Documents/git/secrets.R")
source("~/Documents/git/braindexer/thegraphR/thegraphR.R")
`%notin%` <- Negate(`%in%`)
```

<br>

### Current Allocation Overview

```{r, echo=FALSE, warning=FALSE, message=FALSE}
# total state + signal >> update to subgraph when not broken
total_signal = 4149662.62
total_stake = 750410433.41 + 1585084599.50

# grab all subgraph ID data 
display_names = bind_rows(
  subgraphDisplayNames(0),
  subgraphDisplayNames(1000),
  subgraphDisplayNames(2000)
) %>% select(-deployment_id) %>% 
  filter(network == "mainnet")

# grab indexer's allocation data
indexer_allocations = allocationsByIndexer(wallet_to_analyze) %>% 
  left_join(display_names, by = "subgraph_id") %>% 
  select(display_name, deployment_id, everything()) %>% 
  mutate(proportion = round(((signalled_tokens/total_signal))
         /((staked_tokens/total_stake)),3),
         proportion = if_else(is.infinite(proportion), 0, proportion)) %>% 
  rename(allocation = allocated_tokens)

# check + remove duplicates
duplicates_check = indexer_allocations %>% 
  distinct(deployment_id, subgraph_id) %>% 
  janitor::get_dupes(deployment_id) %>% 
  distinct(deployment_id) %>% left_join(
    indexer_allocations, by = "deployment_id") %>% 
  select(deployment_id, subgraph_id) 
indexer_allocations = indexer_allocations %>% 
  filter(subgraph_id %notin% 
           c("Gdu6LrkdgUWdN8z8CmFzgASoKiSsNYt6HbFjTDurdcm1",
             "CTsPUobKe8nsenurPrg2CcinSoAvLp7XrUZmEWQCzkHS",
             "DCr8gWACNYngjzTPB1Rg5zWtRBajaiRnkh253hBEDpgN",
             "FvNi11TDfCsJMyJtXUn9EKFpJR5WhQUD92sZiUqFGBGt"))

source("~/Documents/git/braindexer/thegraphR/thegraphR.R")
# check blocks behind to check if unallocating is ok 
days_in_past = as.numeric(as.POSIXct((
  as.Date(today(), format="%d/%m/%Y") - 3), format="%Y-%m-%d"))
blocks_behind_df = maxBlocksBehind(wallet_to_analyze, days_in_past) %>% 
  #select(subgraph_deployment_ipfs_hash, avg_indexer_blocks_behind) %>% 
  rename(deployment_id = subgraph_deployment_ipfs_hash,
         blocks_behind = avg_indexer_blocks_behind,
         avg_latency = avg_latency_ms, 
         query_fees = total_query_fees) 

indexer_allocations = indexer_allocations %>% 
  left_join(blocks_behind_df, by = "deployment_id") %>% 
  select(display_name, allocation, proportion, blocks_behind, deployment_id, allocation_id, everything())

viz_indexer_allocations = indexer_allocations %>% select(
  display_name, allocation, proportion, blocks_behind, success_rate,
  avg_latency, query_count, query_fees, deployment_id)
rm(duplicates_check)

# visualize tabe
datatable(viz_indexer_allocations %>% select(-deployment_id), 
  caption = "Current Allocations Overview", rownames = FALSE)
```
<br>

### Indexer Setup

```{shell}
# connect to ethereum/arbitrum
ssh graph@5.9.85.100 
docker run --entrypoint /bin/bash -it ghcr.io/graphprotocol/indexer-cli:v0.20.22
graph indexer connect http://5.9.85.100:30801

# check status 
graph indexer status --network arbitrum-one
graph indexer actions get --status queued --network arbitrum-one
graph indexer actions get all --network arbitrum-one

# allocate to arbitrum
graph indexer rules prepare deployment_id --network arbitrum-one
graph indexer actions queue allocate deployment_id amount_1 --network arbitrum-one
graph indexer actions queue unallocate deployment_id allocation_id --network arbitrum-one
graph indexer actions queue reallocate deployment_id allocation_id amount_1 --network arbitrum-one
graph indexer actions approve id_1 --network arbitrum-one
graph indexer actions execute approved

# prep 
graph indexer rules offchain deployment_id
curl -XPOST https://api.thegraph.com/ipfs/api/v0/cat\?arg\=deployment_id -s | grep graft -A 1

# force close 
graph indexer actions queue unallocate deployment_id allocation_id 0x0 true --force --network arbitrum-one
```

<br>

### Reallocations

#### QoS Verified

```{r, echo=FALSE, comment=NA}
min_allocation = 5000
min_proportion = 1.1
sync_threshold = 5

reallocations_verified = indexer_allocations %>% 
  filter((allocation < (min_allocation+1) | proportion < min_proportion) 
         & (blocks_behind < sync_threshold | !is.na(blocks_behind))) 

for (i in 1:nrow(reallocations_verified)) {
  allocate_action = "graph indexer actions queue reallocate "
  network = " --network arbitrum-one"
  cat(paste0(allocate_action, reallocations_verified$deployment_id[i]," ",
             reallocations_verified$allocation_id[i]," ", 1000, network, " # ",
             reallocations_verified$display_name[i]),sep="\n")
}
cat("graph indexer actions approve transaction_ids --network arbitrum-one\ngraph indexer actions execute approved")
```

<br>

#### QoS Unverified

```{r, echo=FALSE, comment=NA}
reallocations_unverified = indexer_allocations %>% 
  filter((allocation < (min_allocation+1) | proportion < min_proportion) 
         & (is.na(blocks_behind)) & deployment_id %notin% reallocations_verified$deployment_id) 

for (i in 1:nrow(reallocations_unverified)) {
  allocate_action = "graph indexer actions queue reallocate "
  network = " --network arbitrum-one"
  cat(paste0(allocate_action, reallocations_unverified$deployment_id[i]," ",
             reallocations_unverified$allocation_id[i]," ", 1000, network, " # ",
             reallocations_unverified$display_name[i]),sep="\n")
}
cat("graph indexer actions approve transaction_ids --network arbitrum-one\ngraph indexer actions execute approved")
```

<br>

#### Large Reallocations - QoS Verified

```{r, echo=FALSE, comment=NA}
research_allocations = bind_rows(reallocations_verified, reallocations_unverified)

research_allocations = indexer_allocations %>% 
  filter(deployment_id %notin% research_allocations$deployment_id) %>% 
  select(display_name, allocation, proportion, blocks_behind, deployment_id, allocation_id, everything())

large_verified_reallocations = research_allocations %>% 
  filter((proportion > min_proportion) & (!is.na(blocks_behind)))  

for (i in 1:nrow(large_verified_reallocations)) {
  allocate_action = "graph indexer actions queue reallocate "
  network = " --network arbitrum-one"
  cat(paste0(allocate_action, large_verified_reallocations$deployment_id[i]," ",
             large_verified_reallocations$allocation_id[i]," ", 
             large_verified_reallocations$allocation[i], network," # ",
             large_verified_reallocations$display_name[i]),sep="\n")
}
cat("graph indexer actions approve transaction_ids --network arbitrum-one\ngraph indexer actions execute approved")
```

<br>

#### Large Reallocations - QoS Verified

```{r, echo=FALSE, comment=NA}
large_unverified_reallocations = research_allocations %>% 
  filter((proportion > min_proportion) & (is.na(blocks_behind)))  

for (i in 1:nrow(large_unverified_reallocations)) {
  allocate_action = "graph indexer actions queue reallocate "
  network = " --network arbitrum-one"
  cat(paste0(allocate_action, large_unverified_reallocations$deployment_id[i]," ",
             large_verified_reallocations$allocation_id[i]," ", 
             large_unverified_reallocations$allocation[i], network, 
             " # ", large_unverified_reallocations$display_name[i]),sep="\n")
}
cat("graph indexer actions approve transaction_ids --network arbitrum-one\ngraph indexer actions execute approved")
```

<br>

#### Allocations Summary

```{r, echo=FALSE, comment=NA}
check_for_remaining = bind_rows(
  reallocations_verified %>% 
    mutate(allocation_type = "Minimum Verified", new_allocation = 1000), 
  reallocations_unverified %>% 
    mutate(allocation_type = "Minimum Unverified", new_allocation = 1000),
  large_verified_reallocations %>% 
    mutate(allocation_type = "Large Verified", new_allocation = allocation), 
  large_unverified_reallocations %>% 
    mutate(allocation_type = "Large Unverified", new_allocation = allocation)
)

check_for_remaining = check_for_remaining %>%
  group_by(allocation_type) %>% 
  count() %>% 
  arrange(desc(n)) %>% 
  rename(count = n) %>% 
  ungroup() %>% 
  add_row(allocation_type = "GRT Reallocate (Before Profits)", 
          count = (sum(check_for_remaining$allocation) - sum(check_for_remaining$new_allocation)))

datatable(check_for_remaining, 
  caption = "New Allocations Overview", rownames = FALSE)
```





