---
output: html_document
---

```{css, echo=FALSE}
/* this chunk of code centers all of the headings */
h1, h2, h3, h4, h5 {
  text-align: center;
}
```

<br>

```{r pressure, echo=FALSE, fig.align="center", out.width = '150%'}
knitr::include_graphics("query-catcher-header.png")
```

<br>

```{r, include=FALSE, warning=FALSE, message=FALSE}
rm(list = ls())

library("tidyverse")
library("lubridate")
library("plotly")
library("DT")
library("scales")
library("janitor")
#library("notionR")
library("onchainR")
library("here")
source(here("src", "helpers", "notion.R"))

source("~/Documents/git/secrets.R")
source("~/Documents/git/braindexer/thegraphR/thegraphR.R")
indexers = read_csv("~/Documents/git/braindexer/data/indexers.csv")

grt_price = getPriceGRT(braindexer_api_key)

unix_today = as.numeric(as.POSIXct((as.Date(today(), format="%d/%m/%Y")), format="%Y-%m-%d"))
unix_before_1 = as.numeric(as.POSIXct((as.Date(today(), format="%d/%m/%Y") - 1), format="%Y-%m-%d"))
unix_before_3 = as.numeric(as.POSIXct((as.Date(today(), format="%d/%m/%Y") - 3), format="%Y-%m-%d"))
unix_before_7 = as.numeric(as.POSIXct((as.Date(today(), format="%d/%m/%Y") - 7), format="%Y-%m-%d"))
unix_before_14 = as.numeric(as.POSIXct((as.Date(today(), format="%d/%m/%Y") - 14), format="%Y-%m-%d"))
unix_before_30 = as.numeric(as.POSIXct((as.Date(today(), format="%d/%m/%Y") - 30), format="%Y-%m-%d"))

my_query_key = "hosted"
qos_oracle = "https://api.thegraph.com/subgraphs/name/juanmardefago/gateway-qos-oracle"
network_subgraph = "https://api.thegraph.com/subgraphs/name/graphprotocol/graph-network-arbitrum"

#source("~/Documents/git/braindexer/thegraphR/thegraphR.R")
braindexer_allocations = allocationsByIndexer("0x920fdeb00ee04dd72f62d8a8f80f13c82ef76c1e")
braindexer_syncing = braindexer_allocations$deployment_id
subgraphs_metadata = subgraphDisplayNames(0)

daily_subgraphs = queryVolumeByDeploymentOverTime(unix_before_3) %>% 
  mutate(braindexer = if_else(deployment_id %in% braindexer_syncing, "Syncing", "Not Syncing"),
         time_period_rank = "4", time_period = "Past 3D") 

weekly_subgraphs = queryVolumeByDeploymentOverTime(unix_before_7) %>% 
  mutate(braindexer = if_else(deployment_id %in% braindexer_syncing, "Syncing", "Not Syncing"),
         time_period_rank = "3", time_period = "Past 7D") 

fortnite_subgraphs = queryVolumeByDeploymentOverTime(unix_before_14) %>% 
  mutate(braindexer = if_else(deployment_id %in% braindexer_syncing, "Syncing", "Not Syncing"),
         time_period_rank = "2", time_period = "Past 14D")

monthly_subgraphs = queryVolumeByDeploymentOverTime(unix_before_30) %>% 
  mutate(braindexer = if_else(deployment_id %in% braindexer_syncing, "Syncing", "Not Syncing"),
         time_period_rank = "1", time_period = "Past 30D")

combined_subgraphs = bind_rows(
  daily_subgraphs, 
  weekly_subgraphs,
  fortnite_subgraphs
)

# can delete later 
queries_served_by_subgraph = indexersByQueryVolume(unix_before_14)
queries_by_period = queriesByPeriod(queries_served_by_subgraph)

queries_served_by_subgraph_3 = indexersByQueryVolume(unix_before_3) 
queries_by_period_3 = queriesByPeriod(queries_served_by_subgraph_3) %>% mutate(period = "3D")
queries_served_by_subgraph_7 = indexersByQueryVolume(unix_before_7) 
queries_by_period_7 = queriesByPeriod(queries_served_by_subgraph_7) %>% mutate(period = "7D")
queries_served_by_subgraph_14 = indexersByQueryVolume(unix_before_14) 
queries_by_period_14 = queriesByPeriod(queries_served_by_subgraph_14) %>% mutate(period = "14D")
queries_served_by_subgraph_30 = indexersByQueryVolume(unix_before_30)
queries_by_period_30 = queriesByPeriod(queries_served_by_subgraph_30) %>% mutate(period = "30D")

combined_queries_by_period = bind_rows(
  queries_by_period_3, 
  queries_by_period_7,
  queries_by_period_14,
  queries_by_period_30
) %>% left_join(
    queries_by_period_30 %>% 
      select(rank, wallet_address) %>% 
      rename(rank_30d = rank), by = "wallet_address") %>% 
  select(rank_30d, everything()) %>% 
  mutate(period = factor(period, levels = c('30D', '14D', '7D', '3D'))) %>% 
  arrange(rank_30d); rm(queries_by_period_7, queries_by_period_14)

tier1_subgraphs = prepare_tiered_subgraphs(combined_subgraphs, 0, 25)
tier2_subgraphs = prepare_tiered_subgraphs(combined_subgraphs, 25, 49)
tier3_subgraphs = prepare_tiered_subgraphs(combined_subgraphs, 50, 74)
tier4_subgraphs = prepare_tiered_subgraphs(combined_subgraphs, 75, 100)

combined_queries_by_period
```

<details>
  <br>
  <summary><font size="3"> **Top Indexers by Query Volume** </font></summary>
```{r, fig.height=5.5, fig.width=9.5, fig.align="center", echo=FALSE, warning=FALSE, message=FALSE}
upgrade_indexer = "0xbdfb5ee5a2abf4fc7bb1bd1221067aef7f9de491"

indexers_plot = combined_queries_by_period %>% 
  left_join(indexers, by = "wallet_address") %>% 
  mutate(indexer_name = replace_na(indexer_name, "Unknown Indexer"),
         indexer_name = if_else(wallet_address == upgrade_indexer, 
                                "Upgrade Indexer", indexer_name)) %>% 
  group_by(indexer_name, period) %>% 
  summarise(queries_served = sum(queries_served),
            subgraphs_served = sum(subgraphs_served)) 

indexers_rank30d = indexers_plot %>% 
  filter(period == "30D") %>% 
  arrange(desc(queries_served)) 

indexers_rank30d$rank_30d <-  rank(-indexers_rank30d$queries_served)

indexers_plot = indexers_plot %>%
  left_join(indexers_rank30d %>% select(rank_30d, indexer_name), by = "indexer_name") %>% 
  filter(rank_30d < 26) %>% 
  arrange(rank_30d) %>% 
  #left_join(indexers %>% group_by(), by = "indexer_name") %>% 
  mutate(indexer_name = str_replace_all(indexer_name, "Braindexer", "Braindexer"),
         indexer_name = fct_reorder(indexer_name, rank_30d)) %>% 
  ggplot(aes(fill=period, x=fct_reorder(indexer_name, rank_30d), y=queries_served, group = period,
             text=paste0('Indexer: ', indexer_name, 
                         #'<br>Wallet: ', wallet_address, 
                         '<br>',period,' Rank: ', rank_30d, 
                         '<br>',period,' Queries: ', format(queries_served, nsmall=0, big.mark=","),
                         '<br>',period,' Subgraphs Served: ', subgraphs_served))) + 
  geom_bar(stat="identity", width = 0.5, position = position_dodge(width=0.7)) +
  #geom_segment(aes(x=wallet_address, xend=wallet_address, y=0, yend=queries_served), linewidth = 1.2) +
  #geom_point(size=2, alpha=1, stroke=1) +
  theme_minimal() +
  theme(panel.background = element_rect(
        fill = "white", colour = "white", size = 0.5, linetype = "solid"),
        plot.title = element_text(size=14, face="bold", hjust=0.5),
        axis.title.x = element_blank(),
        axis.title.y = element_text(size=6, family = "Arial", colour="#000000"),
        axis.text.x = element_text(size=7, angle = 45, vjust = 0.5, hjust=1),
        axis.text.y = element_text(size=6, family = "Arial", colour="#000000"),
        legend.position = "none") +
   labs(title="The Graph's Indexers - Queries Served (Top 25 - Past 30D)", 
        y = "Queries Served by Indexer (Past 30D)") +
   scale_fill_manual(values=c("#054C70", "#00CED4", "#089DEA", "#E9A1C9")) #+
   #scale_y_continuous(labels = comma)
ggplotly(indexers_plot, tooltip = c("text")) 
```

```{r, echo=FALSE}
queries_table_3 = queries_by_period_3 %>% 
  mutate(queries_3d = str_c(format(queries_served, nsmall=0, big.mark=","),
                             " (",subgraphs_served,")"),
         fees_3d = paste0(
           "USD: $",format(round(query_fees_grt*grt_price, 2), nsmall=0, big.mark=","), "\n",
           "GRT: ",format(round(query_fees_grt, 2), nsmall=0, big.mark=","))) %>% 
  select(wallet_address, queries_3d, fees_3d)

queries_table_30 = queries_by_period_30 %>% 
  mutate(queries_30d = str_c(format(queries_served, nsmall=0, big.mark=","),
                             " (",subgraphs_served,")"),
         fees_30d = paste0(
           "USD: $",format(round(query_fees_grt*grt_price, 2), nsmall=0, big.mark=","), "\n",
           "GRT: ",format(round(query_fees_grt, 2), nsmall=0, big.mark=","))) %>% 
  select(rank, wallet_address, queries_30d, fees_30d)

datatable(queries_table_30 %>% 
  left_join(queries_table_3, by = "wallet_address") %>% 
  left_join(indexers, by = "wallet_address") %>% 
  distinct(rank, indexer_name, queries_30d, fees_30d, queries_3d, fees_3d) %>% 
  mutate(indexer_name = str_replace_all(indexer_name, "Braindexer", "Braindexer")) %>% 
  #select(rank, indexer_name, queries_3d, fees_3d, queries_30d, fees_30d) %>% 
  arrange(rank), 
          caption = "Top Indexers Serving Queries over Past 30 Days", 
          rownames = FALSE,  options = list(pageLength = 15))
```
</details>
<br>

<details>
  <br>
  <summary><font size="3"> **Braindexer Queries Served** </font></summary>
```{r, fig.height=5.5, fig.width=9.5, fig.align="center", echo=FALSE, warning=FALSE, message=FALSE}

combined_queries_by_subgraph = bind_rows(
  queries_served_by_subgraph_3 %>% mutate(period = "3D"), 
  queries_served_by_subgraph_7 %>% mutate(period = "7D"),
  queries_served_by_subgraph_14 %>% mutate(period = "14D"),
  queries_served_by_subgraph_30 %>% mutate(period = "30D")
)

subgraph_totals = combined_queries_by_subgraph %>% 
  rename(deployment_id = subgraph_deployment_ipfs_hash) %>% 
  mutate(total_queries = as.numeric(queries_served),
         total_fees_grt = round(as.numeric(query_fees_grt),2),
         avg_query_fee = as.numeric(avg_query_fee)) %>% 
  group_by(deployment_id) %>% 
  summarize(indexers = n_distinct(wallet_address),
            total_queries = sum(total_queries),
            total_fees_grt = sum(total_fees_grt)) %>% 
  arrange(desc(total_queries)) 

braindexer_subgraphs = combined_queries_by_subgraph %>% 
  rename(deployment_id = subgraph_deployment_ipfs_hash) %>% 
  filter(wallet_address == "0x920fdeb00ee04dd72f62d8a8f80f13c82ef76c1e") %>% 
  mutate(queries_served = as.numeric(queries_served),
         query_fees_grt = round(as.numeric(query_fees_grt),2),
         avg_query_fee = as.numeric(avg_query_fee),
         wallet_address = if_else(
           wallet_address == "0x920fdeb00ee04dd72f62d8a8f80f13c82ef76c1e", 
           str_c("🧠 Braindexer Arbitrum Indexer (0x920-76c1e)"), wallet_address)) %>% 
  group_by(wallet_address, deployment_id, period) %>% 
  summarize(queries_served = sum(queries_served),
            query_fees_grt = sum(query_fees_grt),
            avg_query_fee = mean(avg_query_fee)) %>% 
  left_join(subgraphs_metadata, by = "deployment_id") %>% 
  rename(subgraphs = display_name) %>% 
  mutate(subgraphs = if_else(is.na(subgraphs), str_c(substr(deployment_id, 1, 5),
                                       "-",str_sub(deployment_id,-5,-1)), subgraphs)) %>% 
  select(wallet_address, subgraphs, queries_served, query_fees_grt, deployment_id, period)

braindexer_sync_count = as.character(count(braindexer_subgraphs)$n)
braindexer_query_count = as.character(format(sum(braindexer_subgraphs$queries_served), nsmall=0, big.mark=","))
braindexer_fees_count = as.character(round(sum(braindexer_subgraphs$query_fees_grt),2))
prc_of_network_queries = round(sum(braindexer_subgraphs$queries_served)/sum(subgraph_totals$total_queries)*100,2)

braindexer_table = braindexer_subgraphs %>% 
  left_join(subgraph_totals, by = "deployment_id") %>% 
  ungroup() %>% arrange(desc(query_fees_grt)) %>% 
  mutate(prc_served = round((queries_served/total_queries)*100,2),
         queries_served = format(queries_served, nsmall=0, big.mark=","),
         queries_served = str_c(queries_served, " (", prc_served ,"%)"),
         indexers = as.character(indexers),
         query_fees_grt = as.character(query_fees_grt),
         period = factor(period, levels = c('30D', '14D', '7D', '3D'))) %>% 
  select(wallet_address, subgraphs, queries_served, query_fees_grt, indexers, deployment_id, period) 

revSubstr <- function(x, start, stop) {
  x <- strsplit(x, "")
  sapply(x, 
         function(x) paste(rev(rev(x)[start:stop]), collapse = ""), 
         USE.NAMES = FALSE)
}

braindexer_queries = braindexer_table %>% 
  mutate(queries_served_num = sub("\\(.*", "", queries_served),
         queries_served_num = str_replace_all(queries_served_num, ",", ""),
         queries_served_num = as.numeric(queries_served_num),
         subgraphs = if_else(is.na(subgraphs), 
                             str_c(substr(deployment_id, start = 1, stop = 4),"-",
                                   revSubstr(deployment_id, start = 1, stop = 4)), subgraphs),
         subgraphs = fct_reorder(subgraphs, -queries_served_num)) %>% 
  select(subgraphs, queries_served, queries_served_num, deployment_id, period) %>% 
  ggplot(aes(x=subgraphs, y=queries_served_num, group=period, fill=period,
             text=paste('Subgraph: ', subgraphs, 
                        '<br>Deployment ID: ', deployment_id, 
                        '<br>Period: ', period, 
                        '<br>Queries Served: ', queries_served))) + 
  geom_bar(stat="identity", width = 0.5, position = position_dodge(width=0.7)) +
  theme_minimal() +
  theme(panel.background = element_rect(
        fill = "white", colour = "white", size = 0.5, linetype = "solid"),
        plot.title = element_text(size=14, face="bold", hjust=0.5),
        axis.title.x = element_blank(),
        axis.title.y = element_text(size=8, family = "Arial", colour="#000000"),
        axis.text.x = element_text(size=8, angle = 45, vjust = 0.5, hjust=1),
        axis.text.y = element_text(size=8, family = "Arial", colour="#000000"),
        legend.position = "none") +
   labs(title="Queries Served by Braindexer (Past 30D)", 
        y = "Queries Served by Braindexer (Past 30D)") +
  scale_fill_manual(values=c("30D" = "#054C70", 
                             "14D" = "#00CED4", 
                             "7D" = "#089DEA", 
                             "3D" = "#E9A1C9")) +
   scale_y_continuous(labels = comma)
ggplotly(braindexer_queries, tooltip = c("text")) 
```

```{r, echo=FALSE}
datatable(braindexer_table %>% 
            mutate(braindexer_subgraph = subgraphs,
                   query_fees = str_c(period,": ", query_fees_grt, " GRT")) %>% 
             arrange(desc(period), queries_served) %>%
            select(braindexer_subgraph, query_fees, indexers, deployment_id, -period, -query_fees_grt), 
          caption = "Queries Served by Braindexer (Past 30D)", 
          rownames = FALSE)
```
</details>
<br>

<details>
  <br>
  <summary><font size="3"> **Most Queried Network Subgraphs (Last 3D)** </font></summary>
  
```{r, fig.height=6, fig.width=9.5, fig.align="center", echo=FALSE, warning=FALSE, message=FALSE}
last_3D_data = combined_subgraphs %>% 
  filter(time_period == "Past 3D") %>% 
  mutate(display_name = if_else(is.na(display_name), 
                                str_c(substr(deployment_id, 1, 4),"-",
                                      str_sub(deployment_id,-4,-1)), display_name),
         display_name = if_else(braindexer == "Syncing", str_c(display_name," <<"), display_name), 
         display_name = fct_reorder(display_name, rank)) 

last_3D_plots = last_3D_data %>% 
  filter(rank < 40) %>% 
  ggplot(aes(fill=time_period_rank, x=display_name, y=query_count, #color=braindexer,
             text=paste('Subgraph:', display_name, 
                        '<br>Query Rank:', rank, 
                        '<br>Time Period:', time_period, 
                        '<br>Period Queries:', format(query_count, nsmall=0, big.mark=","),
                        '<br>Success rate:', success_rate, 
                        '<br>Avg latency:', avg_latency, "ms"))) +
  geom_bar(stat="identity", width = 0.5, position = position_dodge(width=0.7)) +
  theme_minimal() +
  theme(plot.title = element_text(size=14, face="bold", hjust=0.5),
        plot.subtitle = element_text(size=11, hjust=0.5),
        axis.title.x=element_blank(),
        axis.text.x = element_text(angle = 45, vjust = 0.5, hjust=1),
        legend.position = "none") +
  ggtitle("Top Graph Network Subgraphs by Query Volume (Past 3D - Top 40)") + 
  ylab("Number of Queries") +
  scale_fill_manual(values=c("#E9A1C9")) + 
  scale_y_continuous(labels = comma)
ggplotly(last_3D_plots, tooltip = c("text")) 
```

```{r, echo=FALSE}
datatable(last_3D_data %>% 
            mutate(query_count = format(query_count, nsmall=0, big.mark=","),
                   success_rate = success_rate,
                   avg_latency = str_c(avg_latency, " ms"),
                   display_name = str_replace_all(display_name, " 🧠", ""),
                   display_name = if_else(braindexer == "Syncing", str_c(">> ", display_name), display_name),
                   display_name = replace_na(display_name, "♻️ Deprecated")) %>% 
            select(rank, display_name, query_count, success_rate, avg_latency, deployment_id), 
            caption = "Top Network Subgraphs by Query Volume (Past 3 Days)", 
            rownames = FALSE)
```

</details>
<br>

<details>
  <br>
  <summary><font size="3"> **Most Queried Network Subgraphs** </font></summary>
```{r, fig.height=5.5, fig.width=9.5, fig.align="center", echo=FALSE, warning=FALSE, message=FALSE}
combined_plots = tier1_subgraphs %>% 
  ggplot(aes(fill=time_period_rank, x=display_name, y=query_count, #color=braindexer,
             text=paste('Subgraph:', display_name, 
                        '<br>Query Rank:', period_rank, 
                        '<br>Time Period:', time_period, 
                        '<br>Period Queries:', format(query_count, nsmall=0, big.mark=","),
                        '<br>Success rate:', success_rate, '<br>Avg latency:', avg_latency, "ms"))) +
  geom_bar(stat="identity", width = 0.5, position = position_dodge(width=0.7)) +
  theme_minimal() +
  theme(plot.title = element_text(size=14, face="bold", hjust=0.5),
        plot.subtitle = element_text(size=11, hjust=0.5),
        axis.title.x=element_blank(),
        axis.text.x = element_text(angle = 45, vjust = 0.5, hjust=1),
        legend.position = "none") +
  ggtitle("Top Graph Network Subgraphs by Query Volume (Past 14D - Top 25)") + 
  ylab("Number of Queries") +
  scale_fill_manual(values=c("#054C70", "#089DEA", "#E9A1C9")) #+ 
 # scale_y_continuous(labels = comma)
ggplotly(combined_plots, tooltip = c("text")) 
```

```{r, echo=FALSE}
tiered_subgraphs = bind_rows(tier1_subgraphs, tier2_subgraphs, tier3_subgraphs, tier4_subgraphs) %>%
  arrange(time_period_rank, chart_rank)

datatable(tiered_subgraphs %>% 
            mutate(query_count = format(query_count, nsmall=0, big.mark=","),
                   success_rate = success_rate,
                   avg_latency = str_c(avg_latency, " ms"),
                   display_name = str_replace_all(display_name, " 🧠", ""),
                   display_name = if_else(braindexer == "Syncing", 
                                          str_c(">>", display_name), display_name),
                   display_name = replace_na(display_name, "♻️ Deprecated")) %>% 
            select(time_period, everything(), -chart_rank, -period_rank, -time_period_rank, -braindexer), 
            caption = "Top Graph Network Subgraphs by Query Volume (Past 14 Days)", 
            rownames = FALSE)
```

**Search Subgraphs:** [Graphscan](https://arbitrum.graphscan.io/#subgraphs) | [Graph Explorer](https://thegraph.com/explorer) | [GraphSeer](https://beta.graphseer.com/)
<br>
<br>

<details>
  <br>
  <summary><font size="3"> **Most Queried Network Subgraphs (Last 30D - Tiers 2-4)** </font></summary>
  
```{r, fig.height=6, fig.width=9.5, fig.align="center", echo=FALSE, warning=FALSE, message=FALSE}
combined_plots = tier2_subgraphs %>% 
  ggplot(aes(fill=time_period_rank, x=display_name, y=query_count, #color=braindexer,
             text=paste('Subgraph:', display_name, 
                        '<br>Query Rank:', period_rank, 
                        '<br>Time Period:', time_period, 
                        '<br>Period Queries:', format(query_count, nsmall=0, big.mark=","),
                        '<br>Success rate:', success_rate, '<br>Avg latency:', avg_latency, "ms"))) +
  geom_bar(stat="identity", width = 0.5, position = position_dodge(width=0.7)) +
  theme_minimal() +
  theme(plot.title = element_text(size=14, face="bold", hjust=0.5),
        plot.subtitle = element_text(size=11, hjust=0.5),
        axis.title.x=element_blank(),
        axis.text.x = element_text(angle = 45, vjust = 0.5, hjust=1),
        legend.position = "none") +
  ggtitle("Top Graph Network Subgraphs by Query Volume (Past 14D - Rank 26-50)") + 
  ylab("Number of Queries") +
  scale_fill_manual(values=c("#054C70", "#089DEA", "#E9A1C9")) + 
  scale_y_continuous(labels = comma)
ggplotly(combined_plots, tooltip = c("text")) 
```

</details>
<br>

